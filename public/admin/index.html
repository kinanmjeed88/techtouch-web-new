<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
  <!-- Netlify Identity Widget -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <style>
    /*
      CSS Rules for making Netlify CMS responsive on small screens.
      Using !important to ensure these styles override the default CMS styles.
    */
    @media (max-width: 767px) {
      
      /* Force the main layout to a vertical stack */
      div[class*="App-main-"] {
        flex-direction: column !important;
        height: auto !important;
      }

      /* Move sidebar to the top, make it a scrollable dropdown area */
      div[class*="Sidebar-container-"] {
        position: relative !important;
        width: 100% !important;
        height: auto !important;
        max-height: 45vh !important; /* Limit height */
        overflow-y: auto !important;
        border-right: none !important;
        border-bottom: 2px solid #e0e0e0 !important;
        margin-bottom: 10px;
      }

      /* Ensure main content area takes full width */
      div[class*="Collection-root-"], 
      div[class*="Editor-root-"] {
        padding: 10px !important;
        width: 100% !important;
      }
      
      div[class*="Collection-main-"], 
      div[class*="Editor-main-"] {
        width: 100% !important;
        /* Allow collection table to scroll horizontally */
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
      }

      /* Force a minimum width on the table to ensure it becomes scrollable */
      table[class*="Table-table-"] {
        min-width: 600px !important; 
      }

      /* Stack the top bar (Search, New Post button) vertically */
      div[class*="Collection-top-root-"] {
        flex-direction: column !important;
        align-items: stretch !important;
        gap: 10px !important;
        padding: 10px 5px !important;
      }

      div[class*="Search-input-"] {
        width: 100% !important;
        margin: 0 !important;
      }

      div[class*="Collection-top-actions-"] {
        display: flex !important;
        flex-direction: column !important;
        align-items: stretch !important;
        gap: 8px !important;
      }
      
      /* Make all buttons in the top bar full-width */
      div[class*="Collection-top-actions-"] button,
      a[class*="Button-button-"] {
        width: 100% !important;
        justify-content: center !important;
        margin-bottom: 5px;
      }
      
      /* Stack editor field labels on top of their inputs */
      div[class*="Field-root-"] {
        flex-direction: column !important;
        align-items: stretch !important;
      }
      
      div[class*="Field-root-"] > label[class*="Label-label-"] {
        margin-bottom: 8px !important;
        text-align: right !important; /* RTL support for labels */
      }

      /* Ensure inputs are full-width */
      textarea, input[type="text"], input[type="string"] {
        width: 100% !important;
      }

      /* Stack the AI helper buttons vertically */
      #ai-helper-buttons {
        flex-direction: column !important;
        gap: 8px !important;
        margin-top: 10px;
      }
      #ai-helper-buttons button {
        width: 100% !important;
        justify-content: center !important;
      }

      /* Improve spacing for editor controls */
      div[class*="Editor-toolbar-"] {
          padding: 5px !important;
      }
      
      div[class*="EditorControl-root-"] {
          padding: 6px !important;
      }
    }
  </style>
</head>
<body>
  <!-- يتضمن سكريبت Netlify CMS -->
  <script src="https://unpkg.com/netlify-cms@^2.0.0/dist/netlify-cms.js"></script>
  <script>
    if (window.netlifyIdentity) {
      window.netlifyIdentity.on("init", user => {
        if (!user) {
          window.netlifyIdentity.on("login", () => {
            document.location.href = "/admin/";
          });
        }
      });
    }
  </script>

  <!-- AI Helper Script -->
  <script>
    const addAiButtons = () => {
      const bodyTextarea = document.querySelector('textarea[id^="body-"]');
      if (!bodyTextarea || bodyTextarea.dataset.aiButtonsAdded) {
        return;
      }
      
      const container = bodyTextarea.parentElement;
      if (!container) return;

      const buttonContainer = document.createElement('div');
      buttonContainer.id = 'ai-helper-buttons';
      buttonContainer.style.display = 'flex';
      buttonContainer.style.gap = '10px';
      buttonContainer.style.marginBottom = '10px';
      
      const createButton = (text, task) => {
          const button = document.createElement('button');
          button.textContent = text;
          button.style.backgroundColor = '#4a5568';
          button.style.color = 'white';
          button.style.border = 'none';
          button.style.padding = '8px 12px';
          button.style.borderRadius = '5px';
          button.style.cursor = 'pointer';
          button.style.fontSize = '14px';
          button.type = 'button';
          
          button.addEventListener('mouseover', () => {
            if (!button.disabled) button.style.backgroundColor = '#2d3748';
          });
          button.addEventListener('mouseout', () => {
            if (!button.disabled) button.style.backgroundColor = '#4a5568';
          });

          button.addEventListener('click', async () => {
            const originalText = button.textContent;
            button.textContent = '...جاري المعالجة';
            button.disabled = true;
            button.style.cursor = 'not-allowed';
            button.style.backgroundColor = '#2d3748';

            try {
              const content = bodyTextarea.value;
              if (!content.trim() && task !== 'complete') { // Allow complete to run on empty for generating content
                  alert('لا يوجد محتوى لمعالجته.');
                  return;
              }

              const response = await fetch('/.netlify/functions/ai-helper', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ content, task }),
              });

              if (!response.ok) {
                  const errorData = await response.json();
                  throw new Error(errorData.error || 'فشل الطلب');
              }

              const data = await response.json();
              
              // This is a more robust way to set the value on a React controlled component
              const nativeTextareaValueSetter = Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype, 'value').set;
              nativeTextareaValueSetter.call(bodyTextarea, data.result);

              // Dispatch events to notify React of the change
              // 'input' is crucial for React to recognize the change.
              // 'change' is added for robustness, as some libraries might listen for it.
              const inputEvent = new Event('input', { bubbles: true });
              const changeEvent = new Event('change', { bubbles: true });
              bodyTextarea.dispatchEvent(inputEvent);
              bodyTextarea.dispatchEvent(changeEvent);


            } catch (error) {
                console.error('AI Helper Error:', error);
                alert(`حدث خطأ: ${error.message}`);
            } finally {
                button.textContent = originalText;
                button.disabled = false;
                button.style.cursor = 'pointer';
                button.style.backgroundColor = '#4a5568';
            }
          });
          return button;
      };

      const summarizeButton = createButton('تلخيص بالذكاء الاصطناعي', 'summarize');
      const reorderButton = createButton('ترتيب كنقاط بالذكاء الاصطناعي', 'reorder');
      const completeButton = createButton('إكمال بالذكاء الاصطناعي', 'complete');

      buttonContainer.appendChild(summarizeButton);
      buttonContainer.appendChild(reorderButton);
      buttonContainer.appendChild(completeButton);
      
      container.insertBefore(buttonContainer, bodyTextarea);
      bodyTextarea.dataset.aiButtonsAdded = 'true';
    };

    const observer = new MutationObserver(() => {
        addAiButtons();
    });

    observer.observe(document.body, { childList: true, subtree: true });

    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(addAiButtons, 1500);
    });
  </script>
</body>
</html>