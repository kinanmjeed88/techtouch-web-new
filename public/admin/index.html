<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
  <!-- Netlify Identity Widget -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <style>
    /*
      CSS Rules for making Netlify CMS responsive on small screens.
      Version 3: More aggressive and specific selectors using !important to 
      ensure these styles override the default CMS styles.
    */
    @media (max-width: 767px) {
      
      /* Main layout: force vertical stacking */
      div[class*="App-main-"] {
        flex-direction: column !important;
        height: auto !important;
      }

      /* Sidebar: move to top, make scrollable */
      div[class*="Sidebar-container-"] {
        position: relative !important;
        width: 100% !important;
        height: auto !important;
        max-height: 40vh !important; /* Limit height to 40% of viewport */
        overflow-y: auto !important;
        border-right: none !important;
        border-bottom: 2px solid #ccc !important;
        margin-bottom: 15px !important;
      }

      /* Content Area: ensure it takes full width */
      div[class*="Collection-root-"], 
      div[class*="Editor-root-"] {
        padding: 10px !important;
        width: 100% !important;
      }
      
      /* Collection Table: Allow horizontal scrolling */
      div[class*="Collection-main-"] {
        width: 100% !important;
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
      }
      table[class*="Table-table-"] {
        min-width: 600px !important; /* Force a min-width to trigger scroll */
      }

      /* Top Bar: stack controls vertically */
      div[class*="Collection-top-root-"] {
        flex-direction: column !important;
        align-items: stretch !important;
        gap: 12px !important;
        padding: 10px !important;
      }

      div[class*="Search-input-"] {
        width: 100% !important;
        margin: 0 !important;
      }

      div[class*="Collection-top-actions-"] {
        display: flex !important;
        flex-direction: column !important;
        align-items: stretch !important;
        gap: 10px !important;
      }
      
      /* Top Bar Buttons: make them full-width */
      div[class*="Collection-top-actions-"] button,
      a[class*="Button-button-"] {
        width: 100% !important;
        justify-content: center !important;
        margin: 0 !important;
      }
      
      /* Editor Fields: Stack label on top of input */
      div[class*="Field-root-"] {
        flex-direction: column !important;
        align-items: stretch !important;
      }
      
      div[class*="Field-root-"] > label[class*="Label-label-"] {
        margin-bottom: 8px !important;
        text-align: right !important; /* RTL support for labels */
        width: 100% !important;
      }

      /* Ensure form elements are full-width */
      textarea, input[type="text"], input[type="string"], .public-DraftEditor-content {
        width: 100% !important;
      }

      /* AI Helper Buttons in CMS: Stack vertically */
      #ai-helper-buttons {
        flex-direction: column !important;
        gap: 8px !important;
        margin-top: 10px !important;
      }
      #ai-helper-buttons button {
        width: 100% !important;
        justify-content: center !important;
      }

      /* Editor Toolbar: Improve spacing on mobile */
      div[class*="Editor-toolbar-"] {
          padding: 5px !important;
          flex-wrap: wrap !important; /* Allow toolbar buttons to wrap */
      }
      
      div[class*="EditorControl-root-"] {
          padding: 6px !important;
      }

      /* Hide login page illustration on small screens */
      div[class*="Login-logo-"] {
        display: none !important;
      }
    }
  </style>
</head>
<body>
  <!-- يتضمن سكريبت Netlify CMS -->
  <script src="https://unpkg.com/netlify-cms@^2.0.0/dist/netlify-cms.js"></script>
  <script>
    if (window.netlifyIdentity) {
      window.netlifyIdentity.on("init", user => {
        if (!user) {
          window.netlifyIdentity.on("login", () => {
            document.location.href = "/admin/";
          });
        }
      });
    }
  </script>

  <!-- AI Helper Script -->
  <script>
    const selectCmsCategory = async (categoryTitle) => {
        const categoryWidget = document.querySelector('div[id^="category-"]');
        if (!categoryWidget) {
            console.warn('Category widget not found.');
            return;
        }

        const control = categoryWidget.querySelector('div[class*="-control"]');
        if (!control) {
            console.warn('Category widget control not found.');
            return;
        }
        
        const downArrow = control.querySelector('div[class*="-indicatorContainer"]');
        if (!downArrow) {
            console.warn('Category dropdown arrow not found.');
            return;
        }

        // 1. Open the dropdown
        downArrow.dispatchEvent(new MouseEvent('mousedown', { bubbles: true }));

        // 2. Wait for options to render
        await new Promise(resolve => setTimeout(resolve, 150));

        // 3. Find and click the option
        const options = Array.from(document.querySelectorAll('div[class*="-option"]'));
        const targetOption = options.find(opt => opt.textContent.trim() === categoryTitle.trim());

        if (targetOption) {
            targetOption.dispatchEvent(new MouseEvent('click', { bubbles: true }));
        } else {
            console.warn(`AI suggested category "${categoryTitle}" not found in dropdown.`);
            alert(`لم يتم العثور على التصنيف المقترح "${categoryTitle}". يرجى اختياره يدويًا.`);
        }
    };
  
    const addAiPostGeneratorButton = () => {
        const bodyTextarea = document.querySelector('textarea[id^="body-"]');
        if (!bodyTextarea || document.getElementById('ai-post-generator-button')) {
            return;
        }
        const container = bodyTextarea.parentElement;
        if (!container) return;

        const button = document.createElement('button');
        button.id = 'ai-post-generator-button';
        button.innerHTML = '✨ إنشاء منشور كامل بالذكاء الاصطناعي';
        button.type = 'button';
        Object.assign(button.style, {
            backgroundColor: '#ef4444',
            color: 'white',
            border: 'none',
            padding: '10px 15px',
            borderRadius: '5px',
            cursor: 'pointer',
            fontSize: '14px',
            fontWeight: 'bold',
            width: '100%',
            marginBottom: '15px',
            transition: 'background-color 0.2s, opacity 0.2s'
        });

        button.addEventListener('mouseover', () => {
          if (!button.disabled) button.style.backgroundColor = '#dc2626';
        });
        button.addEventListener('mouseout', () => {
          if (!button.disabled) button.style.backgroundColor = '#ef4444';
        });

        button.addEventListener('click', async () => {
            const titleInput = document.querySelector('input[id^="title-"]');
            const descriptionTextarea = document.querySelector('textarea[id^="description-"]');
            const linkInput = document.querySelector('input[id^="link-"]');
            const youtubeUrlInput = document.querySelector('input[id^="youtubeUrl-"]');

            const title = titleInput ? titleInput.value : '';
            const description = descriptionTextarea ? descriptionTextarea.value : '';
            const link = linkInput ? linkInput.value : '';

            if (!title.trim()) {
                alert('الرجاء إدخال عنوان للمنشور أولاً.');
                return;
            }

            const originalText = button.innerHTML;
            button.innerHTML = '...جاري إنشاء المحتوى';
            button.disabled = true;
            button.style.cursor = 'not-allowed';
            button.style.opacity = '0.7';

            try {
                const response = await fetch('/.netlify/functions/generate-post', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, description, link }),
                });

                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'فشل الطلب من الخادم.');
                }

                const updateReactInput = (element, value) => {
                    if (!element) return;
                    const nativeSetter = Object.getOwnPropertyDescriptor(element.constructor.prototype, 'value').set;
                    nativeSetter.call(element, value);
                    const event = new Event('input', { bubbles: true });
                    element.dispatchEvent(event);
                };

                updateReactInput(bodyTextarea, data.content || '');
                updateReactInput(youtubeUrlInput, data.youtubeUrl || '');
                if (data.categoryTitle) {
                  selectCmsCategory(data.categoryTitle);
                }


            } catch (error) {
                console.error('AI Post Generator Error:', error);
                alert(`حدث خطأ: ${error.message}`);
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
                button.style.cursor = 'pointer';
                button.style.opacity = '1';
            }
        });

        const existingHelperButtons = document.getElementById('ai-helper-buttons');
        if (existingHelperButtons) {
            container.insertBefore(button, existingHelperButtons);
        } else {
            container.insertBefore(button, bodyTextarea);
        }
    };

    const addAiButtons = () => {
      addAiPostGeneratorButton(); // Add the new post generator button
      
      const bodyTextarea = document.querySelector('textarea[id^="body-"]');
      if (!bodyTextarea || bodyTextarea.dataset.aiButtonsAdded) {
        return;
      }
      
      const container = bodyTextarea.parentElement;
      if (!container) return;

      const buttonContainer = document.createElement('div');
      buttonContainer.id = 'ai-helper-buttons';
      buttonContainer.style.display = 'flex';
      buttonContainer.style.gap = '10px';
      buttonContainer.style.marginBottom = '10px';
      
      const createButton = (text, task) => {
          const button = document.createElement('button');
          button.textContent = text;
          button.style.backgroundColor = '#4a5568';
          button.style.color = 'white';
          button.style.border = 'none';
          button.style.padding = '8px 12px';
          button.style.borderRadius = '5px';
          button.style.cursor = 'pointer';
          button.style.fontSize = '14px';
          button.type = 'button';
          
          button.addEventListener('mouseover', () => {
            if (!button.disabled) button.style.backgroundColor = '#2d3748';
          });
          button.addEventListener('mouseout', () => {
            if (!button.disabled) button.style.backgroundColor = '#4a5568';
          });

          button.addEventListener('click', async () => {
            const originalText = button.textContent;
            button.textContent = '...جاري المعالجة';
            button.disabled = true;
            button.style.cursor = 'not-allowed';
            button.style.backgroundColor = '#2d3748';

            try {
              const content = bodyTextarea.value;
              if (!content.trim() && task !== 'complete') { // Allow complete to run on empty for generating content
                  alert('لا يوجد محتوى لمعالجته.');
                  return;
              }

              const response = await fetch('/.netlify/functions/ai-helper', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ content, task }),
              });

              if (!response.ok) {
                  const errorData = await response.json();
                  throw new Error(errorData.error || 'فشل الطلب');
              }

              const data = await response.json();
              
              const nativeTextareaValueSetter = Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype, 'value').set;
              nativeTextareaValueSetter.call(bodyTextarea, data.result);

              const inputEvent = new Event('input', { bubbles: true });
              const changeEvent = new Event('change', { bubbles: true });
              bodyTextarea.dispatchEvent(inputEvent);
              bodyTextarea.dispatchEvent(changeEvent);


            } catch (error) {
                console.error('AI Helper Error:', error);
                alert(`حدث خطأ: ${error.message}`);
            } finally {
                button.textContent = originalText;
                button.disabled = false;
                button.style.cursor = 'pointer';
                button.style.backgroundColor = '#4a5568';
            }
          });
          return button;
      };

      const summarizeButton = createButton('تلخيص بالذكاء الاصطناعي', 'summarize');
      const reorderButton = createButton('ترتيب كنقاط بالذكاء الاصطناعي', 'reorder');
      const completeButton = createButton('إكمال بالذكاء الاصطناعي', 'complete');

      buttonContainer.appendChild(summarizeButton);
      buttonContainer.appendChild(reorderButton);
      buttonContainer.appendChild(completeButton);
      
      container.insertBefore(buttonContainer, bodyTextarea);
      bodyTextarea.dataset.aiButtonsAdded = 'true';
    };

    const handlePendingPost = () => {
      const pendingTitle = localStorage.getItem('pending_post_title');
      if (!pendingTitle || !window.location.hash.includes('/collections/posts/new')) {
        return;
      }
      
      // Use a timer to wait for the editor to mount
      const interval = setInterval(() => {
        const titleInput = document.querySelector('input[id^="title-"]');
        const generateButton = document.getElementById('ai-post-generator-button');

        if (titleInput && generateButton) {
          clearInterval(interval);
          localStorage.removeItem('pending_post_title');

          const updateReactInput = (element, value) => {
              const nativeSetter = Object.getOwnPropertyDescriptor(element.constructor.prototype, 'value').set;
              nativeSetter.call(element, value);
              const event = new Event('input', { bubbles: true });
              element.dispatchEvent(event);
          };

          updateReactInput(titleInput, pendingTitle);

          setTimeout(() => {
            if (!generateButton.disabled) {
              generateButton.click();
            }
          }, 300);
        }
      }, 200);

      // Timeout to prevent infinite loop
      setTimeout(() => clearInterval(interval), 5000);
    };

    const observer = new MutationObserver(() => {
        addAiButtons();
        handlePendingPost();
    });

    observer.observe(document.body, { childList: true, subtree: true });

    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(addAiButtons, 1500);
    });
  </script>
  
  <!-- Backup, Restore, and Hot Topics Script -->
  <script>
    const addAdvancedToolsUI = () => {
      if (document.getElementById('advanced-tools-container')) {
        return;
      }
      const sidebar = document.querySelector('div[class*="Sidebar-container-"]');
      if (!sidebar) {
        return;
      }

      const container = document.createElement('div');
      container.id = 'advanced-tools-container';
      container.style.padding = '10px 15px';
      container.style.marginTop = '10px';
      container.style.borderTop = '1px solid #4a5568';
      
      const buttonStyle = `display: block; width: 100%; text-align: center; color: white; padding: 10px 12px; border-radius: 5px; cursor: pointer; text-decoration: none; margin-bottom: 10px; font-size: 14px; border: none; font-weight: 500;`;
      
      container.innerHTML = `
        <!-- Hot Topics -->
        <div id="hot-topics-section">
          <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px; color: #e5e7eb;">أحدث المواضيع الرائجة</h3>
          <div id="hot-topics-ui-container">
            <button id="fetch-hot-topics-btn" style="${buttonStyle} background-color: #4b5563;" onmouseover="this.style.backgroundColor='#6b7280'" onmouseout="this.style.backgroundColor='#4b5563'">
              اختر فئة لجلب المواضيع
            </button>
          </div>
        </div>

        <!-- Backup and Restore -->
        <div id="backup-restore-section" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #4a5568;">
          <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px; color: #e5e7eb;">النسخ الاحتياطي والاستعادة</h3>
          <a 
            href="/.netlify/functions/backup" 
            download="techtouch0-backup-${new Date().toISOString().split('T')[0]}.json"
            style="${buttonStyle} background-color: #374151;"
            onmouseover="this.style.backgroundColor='#4b5563'"
            onmouseout="this.style.backgroundColor='#374151'"
          >
            إنشاء وتنزيل نسخة احتياطية
          </a>
          <div style="position: relative;">
            <input type="file" id="restore-input" accept=".json" style="display: none;">
            <button 
              id="restore-button" 
              style="${buttonStyle} background-color: #dc2626; font-weight: bold;"
              onmouseover="this.style.backgroundColor='#b91c1c'"
              onmouseout="this.style.backgroundColor='#dc2626'"
            >
              استعادة من ملف
            </button>
          </div>
          <div id="restore-status" style="margin-top: 12px; font-size: 14px; text-align: center; min-height: 20px;"></div>
        </div>
      `;

      sidebar.appendChild(container);

      // --- Hot Topics Logic ---
      const hotTopicsBtn = document.getElementById('fetch-hot-topics-btn');
      const hotTopicsUiContainer = document.getElementById('hot-topics-ui-container');

      hotTopicsBtn.addEventListener('click', () => {
        hotTopicsUiContainer.innerHTML = '';
        const topics = {
          "أخبار تقنية": "Latest Technology News",
          "تطبيقات رياضية": "Trending Sports Apps",
          "تطبيقات أفلام": "New and Popular Movie Streaming Apps",
          "ذكاء اصطناعي": "Breakthroughs in Artificial Intelligence"
        };
        
        Object.entries(topics).forEach(([label, topic]) => {
          const btn = document.createElement('button');
          btn.textContent = label;
          btn.style.cssText = `${buttonStyle} background-color: #4a5568;`;
          btn.onmouseover = () => btn.style.backgroundColor = '#6b7280';
          btn.onmouseout = () => btn.style.backgroundColor = '#4a5568';
          btn.onclick = () => fetchAndDisplayTopics(topic, hotTopicsUiContainer);
          hotTopicsUiContainer.appendChild(btn);
        });
      });

      const fetchAndDisplayTopics = async (topic, uiContainer) => {
        uiContainer.innerHTML = `<p style="color: #9ca3af; text-align: center;">... جاري البحث عن أفضل 10 مواضيع</p>`;
        try {
          const response = await fetch('/.netlify/functions/get-hot-topics', {
            method: 'POST',
            body: JSON.stringify({ topic }),
          });
          const titles = await response.json();
          if (!response.ok) throw new Error(titles.error || 'فشل جلب المواضيع');

          uiContainer.innerHTML = `
            <p style="color: #d1d5db; font-weight: 500; margin-bottom: 8px;">اختر موضوعًا لإنشاء منشور عنه:</p>
            <ul style="list-style: none; padding: 0; margin: 0; max-height: 250px; overflow-y: auto;">
              ${titles.map(title => `<li style="padding: 8px; color: #e5e7eb; cursor: pointer; border-radius: 4px;" onmouseover="this.style.backgroundColor='#4b5563'" onmouseout="this.style.backgroundColor='transparent'" data-title="${encodeURIComponent(title)}">${title}</li>`).join('')}
            </ul>`;
            
          uiContainer.querySelector('ul').addEventListener('click', (e) => {
            const target = e.target;
            if (target.tagName === 'LI') {
              const title = decodeURIComponent(target.dataset.title);
              localStorage.setItem('pending_post_title', title);
              window.location.hash = '/collections/posts/new';
            }
          });
        } catch(e) {
          uiContainer.innerHTML = `<p style="color: #f87171;">خطأ: ${e.message}</p>`;
        }
      };

      // --- Restore Logic ---
      const restoreInput = document.getElementById('restore-input');
      const restoreButton = document.getElementById('restore-button');
      const restoreStatus = document.getElementById('restore-status');
      
      restoreButton.addEventListener('click', () => restoreInput.click());
      restoreInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const isConfirmed = confirm('هل أنت متأكد؟ سيتم حذف جميع المنشورات والتصنيفات والإعدادات الحالية واستبدالها بالبيانات من ملف النسخة الاحتياطية. لا يمكن التراجع عن هذا الإجراء.');
        if (!isConfirmed) {
          event.target.value = '';
          return;
        }

        restoreStatus.textContent = '...جاري الاستعادة، قد يستغرق هذا بعض الوقت';
        restoreStatus.style.color = '#9ca3af';
        restoreButton.disabled = true;

        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            const backupData = JSON.parse(e.target.result);
            const response = await fetch('/.netlify/functions/restore', {
              method: 'POST', body: JSON.stringify(backupData)
            });
            const responseData = await response.json();
            if (!response.ok) throw new Error(responseData.error);
            restoreStatus.textContent = 'تمت الاستعادة بنجاح! سيتم إعادة تحميل الصفحة.';
            restoreStatus.style.color = '#34d399';
            alert('تمت الاستعادة بنجاح!');
            window.location.reload();
          } catch (error) {
            restoreStatus.textContent = `خطأ: ${error.message}`;
            restoreStatus.style.color = '#f87171';
            restoreButton.disabled = false;
          }
        };
        reader.readAsText(file);
      });
    };
    
    const initAdvancedToolsUI = () => {
        setInterval(addAdvancedToolsUI, 1000);
    };

    document.addEventListener('DOMContentLoaded', initAdvancedToolsUI);
  </script>
</body>
</html>